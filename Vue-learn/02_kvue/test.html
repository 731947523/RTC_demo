<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="app">
        {{counter}}
    </div>
    <script>
        let { patch, h } = snabbdom
        console.log('look....', { patch, h });

        function defineReactive(obj, key, val){
            observe(val)
            const dep = new Dep()
            Object.defineProperty(obj, key, {
                get(){
                    // console.log(dep, Dep.target, 'dep');
                    Dep.target && dep.addDep(Dep.target)
                    console.log('get:', key, ' value:', val);
                    return val
                },
                set(newVal){
                    if(val != newVal){
                        observe(newVal)
                        val = newVal
                        dep.notify()
                    }
                }
            })
        }

        function observe(obj){
            if(typeof obj !== 'object' || obj == null){
                return
            }
            new Observe(obj)
        }
        function proxy(vm, sourceKey){
            Object.keys(vm[sourceKey]).forEach(key => {
                Object.defineProperty(vm, key, {
                    get(){
                        return vm[sourceKey][key]
                    },
                    set(newVal){
                        vm[sourceKey][key] = newVal
                    }
                })
            })
        }

        
        class Observe{
            constructor(data){
                this.$data = data

                if(typeof data === 'object'){
                    this.walk(data)
                }
            }

            walk(obj){
                Object.keys(obj).forEach(key => {
                    defineReactive(obj, key, obj[key])
                })
            }
        }

        class Vue{
            constructor(options){
                this.options = options
                this.$el = options.el
                this.$data = options.data()

                // 1 进行响应式
                observe(this.$data)
                proxy(this, '$data')

                new Compile(this, this.$el)
            }
        }
        
 
        class Dep{
            constructor(){
                this.deps = []
            }
            addDep(watch){
                this.deps.push(watch)
            }
            notify(){
                this.deps.forEach(w=>w.update())
            }
        }

        class Watch{
            constructor(vm, key, updateFun){

                this.$vm = vm
                this.key = key
                this.updateFun = updateFun

                Dep.target = this
                this.$vm[this.key]
                Dep.target = null
            }
            
            update(){
                this.updateFun.call(this, this.$vm[this.key])
            }



        }
        
        class Compile{
            constructor(vm,el){
                this.$vm = vm
                this.$el = document.querySelector(el)
                
                if(this.$el){
                    this.compile(this.$el)
                }
            }
            compile(el){
                const childNodes = el.childNodes;
                Array.from(childNodes).forEach((node) => {
                    if(this.isElement(node)){
                        // this.compileElement(node)
                    }else if(this.isInter(node)){
                        this.compileText(node, RegExp.$1)
                    }
                    if(node && node.childNodes.lenth > 0){
                        this.compile(node)
                    }
                })
            }

            update(node, exp, dir){
                const fn = this[dir + 'Update']
                fn && fn(node, this.$vm[exp])
                new Watch(this.$vm, exp, function(val){
                    fn && fn(node, val)
                })
            }

            textUpdate(node, val){
                // console.log(node, val);
                node.textContent = val
            }



            compileText(node, exp){
                // node.textContent = this.$vm[exp]
                this.update(node, exp, 'text')

            }

            isElement(node){
                // console.log(node);
                return node.nodeType == 1
            }

            isInter(node){
                // console.log(node.nodeType,/\{\{(.*)\}\}/.test(node.textContent), node.textContent );
                return node.nodeType == 3 && /\{\{(.*)\}\}/.test(node.textContent)
            } 
        }

      
        const app = new Vue({
            el:'#app',
            data() {
                return{
                    counter: 55
                }
            }
        })
        setInterval(() => {
            app.counter++
        }, 1000);


    </script>
</body>
</html>