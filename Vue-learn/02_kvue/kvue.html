<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>独立的Vue 1.0版本</title>
</head>
<!-- <script src="../../complex_vue/node_modules/vue/dist/vue.js"></script> -->
<body>
    <div id="app">
            {{count}}
            <p>{{count}}</p>
        <p k-html='testHtml'></p>
        <p k-text='count'>{{count}}</p>
    </div>
</body>
<script>
    function defineReactive(obj, key, val) {
        observe(val)
        const dep = new Dep()
        Object.defineProperty(obj, key, {
            get(){
                Dep.target && dep.addDep(Dep.target)
                console.log(`get: ${key}, value: ${val}`)
                return val
            },
            set(newVal) {
                if(newVal!==val){
                    console.log('进行设置值---', newVal);
                    observe(newVal)
                    val = newVal
                    dep.notify()
                }
            }
        })
    }

    function observe(obj){
        if(typeof obj !== 'object' || obj == null){
            return
        }

        new Observe(obj)
    }

    class Observe{
        constructor(value){
            this.value = value
            if(typeof value === 'object'){
                this.walk(value)
            } else {
                // 执行数组

            }
        }

        // 对象数据的响应化
        walk(obj){
            Object.keys(obj).forEach(key=>{
                defineReactive(obj, key, obj[key])
            })
        }
    }

    class KVue{
        constructor(options){
            this.$options = options
            this.$data = options.data()

            observe(this.$data)

            // 代理函数，方便用户直接使用数据
            proxy(this, '$data')
            new Compile(this.$options.el, this)
        }
    }

    function proxy(vm, sourceKey){
        // 主要是为了将$data 代理到vm
        Object.keys(vm[sourceKey]).forEach(key=>{
            Object.defineProperty(vm, key, {
                get(){
                    return vm[sourceKey][key]
                },
                set(newVal){
                    if(newVal != vm[sourceKey][key]){
                        vm[sourceKey][key] = newVal
                    }
                }
            })

        })

    }

    // Dep 进行可以和watch 1:1
    class Dep{
        constructor(){
            this.deps = []
        }

        addDep(dep){
            this.deps.push(dep)
        }

        notify(){
            this.deps.forEach(dep=>{
                dep.update()
            })
        }
    }

    class Watch{
        constructor(vm, key, updateFn){

            this.$vm = vm
            this.key = key
            this.updateFn = updateFn

            Dep.target = this
            this.$vm[this.key]
            Dep.target = null

        }

        update(){
            this.updateFn.call(this.$vm, this.$vm[this.key])
        }


    }

    // 编译类
    class Compile{
        constructor(el, vm){
            this.$el = document.querySelector(el)
            this.$vm = vm

            if(this.$el){
                this.compile(this.$el)
            }
        }

        compile(el){
            let childNode = el.childNodes
            Array.from(childNode).forEach(node=>{
                if(this.isElement(node)){   // 编译Element
                    // this.compileElement(node)
                }else if(this.isInter(node)){ // 编译NodeType 为3 且是纯文本
                    // this.compileInter(node)
                    this.update(node, RegExp.$1, 'text')
                }

                if(node.childNodes && node.childNodes.length>0){
                    this.compile(node)
                } 
            })
        }

        update(node, exp, dir){
            const fn = this[dir+'Update']
            fn && fn(node, this.$vm[exp])
            new Watch(this.$vm, exp, function(val){
               fn && fn(node, val)
            })
        }

        textUpdate(node,value){
            node.textContent = value
        }

        compileElement(node){
            let nodeAttrs = node.attributes;
            Array.from(nodeAttrs).forEach(attr => {
                let attrName = attr.name;
                let exp = attr.value;
                if(attrName.indexOf('k-') == 0){
                    let dir = attrName.substring(2)
                    this[dir] && this[dir](node, exp)
                    // let that = this
                    // console.log('？？？？');
                    // console.log(this[dir], node, this.$vm[exp]);
                    // new Watch(this.$vm, exp, function(val){
                    //     that[dir] && that[dir](node, val)
                    // })
                }
            })
        }

        compileInter(node){
            node.textContent = this.$vm[RegExp.$1]
        }

        text(node, exp){
            node.textContent = this.$vm[exp]
        }

        html(node, exp){
            node.innerHTML = this.$vm[exp]
        }

        isElement(node){
            return node.nodeType == 1
        }

        isInter(node){ // {{}} 模式
            return node.nodeType == 3 && /\{\{(.*)\}\}/.test(node.textContent)
        }
    }





    const app = new KVue({
        name:'home',
        el:'#app',
        data() {
            return {
                count: 0,
                testHtml:'我这是一个Html的绑定',
            }
        },
    })
    // setInterval(() => {
    //     // app.$data.count
    //     app.count++
    // }, 1000);
    setTimeout(() => {
        app.count++
    }, 1000);
</script>
</html>