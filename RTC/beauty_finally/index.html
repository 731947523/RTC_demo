<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Texture Source Canvas</title>
    </head>
<body>
    <h4>需先设置美颜等级</h4>
    value: <span class="span"></span>
    <input type="range" value="0" max='10' min="0" id="slider">
    <button class="but">start beauty</button>
    <button class="replace"> replace beauty</button>
    <button class="stop"> stop beauty</button>
    <button class="stopVideo"> stop video</button>
    <video class="video" src="" autoplay controls width="720" height="480"></video>
    <div class="canvasWrap"> </div>
    <script src="./beauty_string.js"></script>
    <script src="./beauty.js"></script>
<script>
    window.onload = function(){
        let captureMediaStream = null
        let captureVideo = document.querySelector('.video')
        let virtualVideo = document.createElement('video')

        let real = null
        let bea = new window.Beauty()


        var slider = document.querySelector('#slider')
        slider.onchange = function(){
            document.querySelector('.span').innerText = `0.${slider.value}`
            bea.setBeautyLevel(`0.${slider.value}`)
        }

        let cloneStream = new MediaStream()
        window.cloneStream = cloneStream

        document.querySelector('.but').addEventListener('click', ()=>{
            navigator.mediaDevices.getUserMedia({video: {width: 720, height: 480 }, audio: false}).then(mediaStream => {
                // 将stream保存，销毁美颜时使用
                captureMediaStream = mediaStream 
                
                cloneStream.addTrack(mediaStream.getVideoTracks()[0])
                virtualVideo.srcObject = mediaStream
                virtualVideo.play()
                captureVideo.srcObject = cloneStream
            })
        })
        document.querySelector('.replace').addEventListener('click', ()=>{
            bea.init(virtualVideo, {
                width: 720,
                height: 480
            })
            bea.setBeautyLevel(0.9)
            bea.startDraw(virtualVideo)
            cloneStream.removeTrack(cloneStream.getVideoTracks()[0])
            cloneStream.addTrack(bea.getCap().getVideoTracks()[0])
        })

        document.querySelector('.stop').addEventListener('click', ()=>{
            bea.destroy(captureMediaStream, cloneStream)
        })

        document.querySelector('.stopVideo').addEventListener('click', ()=>{
            captureMediaStream.getTracks().forEach((track) => {
                track.stop();
            })
        })



        
    }
</script>
</body>
<html>